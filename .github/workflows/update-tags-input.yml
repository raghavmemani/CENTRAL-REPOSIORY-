name: dropdown-options-update
permissions:
  contents: write
  actions: write

on:
  # Trigger automatically when pom.xml or script changes
  push:
    paths:
      - pom.xml
      - .github/workflows/update-workflow-options.sh

  # Allow manual run from GitHub UI
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    permissions:
      contents: write   # REQUIRED to push changes back to repo

    steps:
      # --------------------------
      # Checkout repository
      # --------------------------
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------
      # Debug repo structure
      # --------------------------
      - name: Debug repo files
        run: |
          echo "===== ROOT FILES ====="
          ls -la
          echo "===== WORKFLOWS ====="
          ls -la .github/workflows

      # --------------------------
      # Install yq (NO Maven)
      # --------------------------
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      # --------------------------
      # Make script executable
      # --------------------------
      - name: Make update script executable
        run: chmod +x .github/workflows/update-workflow-options.sh

      # --------------------------
      # Show workflow BEFORE
      # --------------------------
      - name: Show test-and-deploy.yml BEFORE
        run: |
          echo "===== BEFORE ====="
          cat .github/workflows/test-and-deploy.yml || true

      # --------------------------
      # Run update script
      # --------------------------
      - name: Run update-workflow-options.sh
        run: |
          set -euo pipefail
          .github/workflows/update-workflow-options.sh

      # --------------------------
      # Show workflow AFTER
      # --------------------------
      - name: Show test-and-deploy.yml AFTER
        run: |
          echo "===== AFTER ====="
          cat .github/workflows/test-and-deploy.yml || true

